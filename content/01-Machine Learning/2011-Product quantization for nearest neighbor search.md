---
title: "2011-Product quantization for nearest neighbor search"
layout: page
date: 2020-05-13
---


## 主要内容

- Backgroud
    - 量化是指将数据通过某种函数映射到有限集合的过程，分为标量量化和矢量量化。
    - 标量量化是指维度为1的矢量量化，一个p维最佳矢量量化器性能总是优于p个最佳标量量化器，但矢量量化的复杂度更高。
    - 衡量的标准为，相同的编码速率下，矢量量化的失真度更小。
    
- 加速相似度搜索的方法
    - 基于树的方法，如KD树
    - Hash方法，如LSH
    - 矢量量化方法，如乘积量化PQ
    
- 矢量量化（Vector Quantization）
    - 普通的量化是单维的，矢量量化是指将数据在多维空间中进行整体量化。相比于单维量化，矢量量化考虑了数据各个维度之间的关系，量化效果更好。
    - 优化目标是失真度，如原始数据与量化后数据向量差的F范数。

- 倒排 —— 减少相似度计算次数
    - 利用K-means对数据做聚类，得到数据对应的聚类中心，即索引。
    - 将待搜索数据与聚类中心先比较，选取前n个聚类中心，再将待待搜索数据与这n个聚类中心对应的数据计算相似度即可。
     
- VLAD（vector of locally aggregated descriptors） —— 数据有多个特征向量
    - 获得数据的d维特征向量
    - 将所有数据利用d维特征向量聚类得到k个聚类中心
    - 把每一个数据所有的特征向量映射到k个聚类中心
    - 对每个数据所有的特征向量与对应的聚类中心做残差和
    - 对这个残差和做L2归一化，然后拼接成一个K*d的长向量。
    - 上述e步骤得到的就是数据VLAD特征，将所有数据计算得到VLAD特征后存储到数据库，之后对查询数据做上述操作，与数据库中对比即可。

- 乘积量化PQ（Product Quantization）—— 减少内存使用， 提高速度
    - 乘积量化中的乘积是指笛卡尔积（Cartesian product），具体是把原始向量空间分解为m个低维向量空间的笛卡尔积，并对分解得到的低维向量空间分别做量化，使得向量由多个低维空间的量化code组合表示。
    - 具体的，它将d维当原始向量划分为m个组，对每一组都用k-means算法聚类得到码本，所以一共得到m个码本。之后将向量分别对应到每个码本中，并利用笛卡尔积得到向量的编码结果。
    - 当m=1时，乘积量化就等价于矢量量化，当m=d时，相当于对向量的每一维都用kmeans计算码本。
    
- 搜索方式
    - 建立好乘积量化器后，需要利用相似度搜索方式做搜索，主要包括SDC(symmetric distance computation)，ADC(asymmetric distance computation)
   
- PQ的改进——基于PQ的倒排索引
    - 当数据量n>>kd时，对计算量影响较大的还是数据量n，虽然PQ已经做了一定的简化，但计算量还是很大，所以就提出了基于倒排索引的PQ，其步骤如下：
    - 粗量化，利用k-means将原始数据分为k个类别，k取值在sqrt(n)附近。
    - 计算每个数据和其对应类别中心的残差，分别对每个类别中数据的上述残差做PQ量化。用PQ处理残差，而不是原始数据的原因是残差的方差或者能量比原始数据的方差或者能量要小。
    - 在Faiss中具体实现基于PQ的倒排索引时又做了一些处理，具体步骤如下：
    - n个样本点利用k-means粗聚类，得到k个聚类中心
    - 对每个聚类中心的数据进行采样，得到ns个采样数据
    - 计算这ns个数据与聚类中心的残差
    - 用PQ处理上述ns个残差，得到码本
    - 将所有数据映射到上述码本
    - 搜索时由于倒排的原因，需要搜索前几个聚类中心